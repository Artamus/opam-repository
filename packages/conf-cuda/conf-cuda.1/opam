opam-version: "2.0"
maintainer: "Lukasz Stafiniak <lukstafi@gmail.com>"
authors: [
    "NVidia"
]
homepage: "https://docs.nvidia.com/cuda/"
license: "CUDA Toolkit End User License Agreement <https://docs.nvidia.com/cuda/eula/index.html>"
# We do not restrict availability to let users install CUDA themselves.
build: [
  ["sh" "-exc" "cat <<EOF > test.c
   #include  \"cuda.h\"
   #include  \"nvrtc.h\"
   "]
  ["sh" "-exc" "cc -c $CFLAGS -I%{conf-cuda-config:cuda_path}%/include test.c"]
]
# Note: the minimal set of packages directly from NVidia repositories, e.g. for cudajit:
# "cuda-cudart-X-Y" "cuda-cudart-dev-X-Y" "cuda-runtime-X-Y" "cuda-nvrtc-X-Y" "cuda-nvrtc-dev-X-Y"
# where e.g. X=12, Y=4 is the CUDA version.
depends: [ "conf-cuda-config" ]
depexts: [
  ["nvidia-cuda-dev" "nvidia-cuda-toolkit"]
  {!conf-cuda-config:is_wsl & !conf-cuda-config:cuda_preinstalled & os-family = "debian"}
  ["CUDA" "CUDA-tools"]
  {!conf-cuda-config:is_wsl & !conf-cuda-config:cuda_preinstalled &
   (os-family = "opensuse" | os-distribution = "opensuse-leap" | os-distribution = "opensuse-tumbleweed")}
  ["cuda"] {!conf-cuda-config:is_wsl & !conf-cuda-config:cuda_preinstalled & os-family = "arch"}
]
setenv: [
  [ CUDA_PATH = "%{conf-cuda-config:cuda_path}%" ]
]
post-messages: [
  "DEBUG: [1] {!conf-cuda-config:is_wsl & !conf-cuda-config:cuda_preinstalled & os-family = debian}"
  {!conf-cuda-config:is_wsl & !conf-cuda-config:cuda_preinstalled & os-family = "debian"}
  "DEBUG: [2] {!conf-cuda-config:is_wsl & !conf-cuda-config:cuda_preinstalled & os-family = arch}"
  {!conf-cuda-config:is_wsl & !conf-cuda-config:cuda_preinstalled & os-family = "arch"}
  "DEBUG: [3] {!conf-cuda-config:is_wsl}"
  {!conf-cuda-config:is_wsl}
  "DEBUG: [4] {!conf-cuda-config:cuda_preinstalled}"
  {!conf-cuda-config:cuda_preinstalled}
  "DEBUG: [5] {conf-cuda-config:is_wsl}"
  {conf-cuda-config:is_wsl}
  "DEBUG: [6] {conf-cuda-config:cuda_preinstalled}"
  {conf-cuda-config:cuda_preinstalled}
  "DEBUG: [7] {os-family = debian}"
  {os-family = "debian"}

  "NOTE: under WSL, manually install CUDA, this package will not install it. See https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#network-repo-installation-for-wsl Failing configuration: cuda preinstalled %{conf-cuda-config:cuda_preinstalled}%, CUDA_PATH=%{conf-cuda-config:cuda_path}%, is-WSL %{conf-cuda-config:is_wsl}%, OS family %{os-family}%"
  {failure & conf-cuda-config:is_wsl}
  "Manually install CUDA, set the CUDA_PATH environment variable if different from /usr/local/cuda, re-install opam package conf-cuda-config, when installing this package ignore request for external dependencies if any (answer 3, or nny). See: https://docs.nvidia.com/cuda/ Failing configuration: cuda preinstalled %{conf-cuda-config:cuda_preinstalled}%, CUDA_PATH=%{conf-cuda-config:cuda_path}%, is-WSL %{conf-cuda-config:is_wsl}%, OS family %{os-family}%"
  {failure & !conf-cuda-config:is_wsl}
]
synopsis: "Virtual package relying on a CUDA system installation"
description:
  "This package can only install if CUDA is installed on the system."
bug-reports: "https://github.com/ocaml/opam-repository/issues"
flags: conf
