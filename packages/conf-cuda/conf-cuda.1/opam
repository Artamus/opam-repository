opam-version: "2.0"
maintainer: "Lukasz Stafiniak <lukstafi@gmail.com>"
authors: [
    "NVidia"
]
homepage: "https://docs.nvidia.com/cuda/"
license: "CUDA Toolkit End User License Agreement <https://docs.nvidia.com/cuda/eula/index.html>"
# We do not restrict availability to let users install CUDA themselves.
build: [
  ["sh" "-exc" "cat <<EOF > test.c
   #include  \"cuda.h\"
   #include  \"nvrtc.h\"
   "]
  ["sh" "-exc" "cc -c $CFLAGS -I$(CUDA_PATH)/include test.c"]
]
# Note: the minimal set of packages directly from NVidia repositories, e.g. for cudajit:
# "cuda-cudart-X-Y" "cuda-cudart-dev-X-Y" "cuda-runtime-X-Y" "cuda-nvrtc-X-Y" "cuda-nvrtc-dev-X-Y"
# where e.g. X=12, Y=4 is the CUDA version.
depends: [ "conf-cuda-config" ]
depexts: [
  ["nvidia-cuda-dev" "nvidia-cuda-toolkit"]
  {!conf-cuda-config:is_wsl & !conf-cuda-config:cuda_preinstalled & os-family = "debian"}
  ["CUDA" "CUDA-tools"]
  {!conf-cuda-config:is_wsl & !conf-cuda-config:cuda_preinstalled &
   (os-family = "opensuse" | os-distribution = "opensuse-leap" | os-distribution = "opensuse-tumbleweed")}
  ["cuda"] {!conf-cuda-config:is_wsl & !conf-cuda-config:cuda_preinstalled & os-family = "arch"}
]
setenv: [
  [ CUDA_PATH = "%{conf-cuda-config:cuda_path}%" ]
]
build-env: [
  [ CUDA_PATH = "%{conf-cuda-config:cuda_path}%" ]
]
messages: [
  "WARNING: under WSL, manually install CUDA, when installing this package ignore request for external dependencies if any (answer 3, or nny). See https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#network-repo-installation-for-wsl"
  {os = "linux"}
  "NOTE: Add the multiverse repository `sudo add-apt-repository multiverse; sudo apt update`. Or manually install CUDA, see https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html"
  {os-family = "debian" & os-distribution != "ubuntu"}
]
post-messages: [
  "Manually install CUDA, set the CUDA_PATH environment variable if different from /usr/local/cuda, when installing this package ignore request for external dependencies if any (answer 3, or nny). See: https://docs.nvidia.com/cuda/"
  {failure & os-family != "arch"}
  "Manually install CUDA ensuring headers are under /opt/cuda/include and library objects under /opt/cuda/lib64, when installing this package ignore request for external dependencies (answer 3, or nny). See: https://docs.nvidia.com/cuda/"
  {failure & os-family = "arch"}
]
synopsis: "Virtual package relying on a CUDA system installation"
description:
  "This package can only install if CUDA is installed on the system."
bug-reports: "https://github.com/ocaml/opam-repository/issues"
flags: conf
